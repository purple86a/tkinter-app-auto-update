<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <!-- 
    WiX 6.x Setup for MyApp 
    This file defines the MSI package structure.
  -->
  
  <Package Name="MyApp" 
           Manufacturer="YourCompany" 
           Version="$(var.Version)" 
           UpgradeCode="4f5e6d7c-8b9a-0d1e-2f3a-4b5c6d7e8f9a"
           Scope="perMachine"
           InstallerVersion="500"
           Language="1033">

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." 
                  Schedule="afterInstallInitialize" />

    <!-- Define the media (CAB file embedded in MSI) -->
    <MediaTemplate EmbedCab="yes" />

    <!-- Install to Program Files\MyApp -->
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="INSTALLFOLDER" Name="MyApp" />
    </StandardDirectory>

    <!-- Start Menu shortcut folder -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="MyApp" />
    </StandardDirectory>

    <!-- Desktop folder for shortcut -->
    <StandardDirectory Id="DesktopFolder" />

    <!-- Define the components -->
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <!-- The main executable -->
      <Component Id="MainExecutable" Guid="a1b2c3d4-e5f6-7890-abcd-ef1234567890">
        <File Id="MyAppEXE" Source="dist\main.exe" KeyPath="yes" />
        <RegistryValue Root="HKLM" Key="Software\YourCompany\MyApp" Name="InstallPath" Type="string" Value="[INSTALLFOLDER]" />
      </Component>

      <!-- version.txt for the app to read its version -->
      <Component Id="VersionFile" Guid="b2c3d4e5-f6a7-8901-bcde-f23456789012">
        <File Id="VersionTxt" Source="version.txt" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Start Menu Shortcut -->
    <ComponentGroup Id="ShortcutComponents" Directory="ApplicationProgramsFolder">
      <Component Id="StartMenuShortcut" Guid="c3d4e5f6-a7b8-9012-cdef-345678901234">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="MyApp"
                  Description="MyApp Application"
                  Target="[INSTALLFOLDER]main.exe"
                  WorkingDirectory="INSTALLFOLDER" />
        <RemoveFolder Id="CleanUpShortcutFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\YourCompany\MyApp" Name="StartMenuShortcut" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Desktop Shortcut -->
    <ComponentGroup Id="DesktopShortcutComponents" Directory="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="d4e5f6a7-b8c9-0123-defa-456789012345">
        <Shortcut Id="ApplicationDesktopShortcut"
                  Name="MyApp"
                  Description="MyApp Application"
                  Target="[INSTALLFOLDER]main.exe"
                  WorkingDirectory="INSTALLFOLDER" />
        <RegistryValue Root="HKCU" Key="Software\YourCompany\MyApp" Name="DesktopShortcut" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Feature definition -->
    <Feature Id="MainFeature" Title="MyApp" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="ShortcutComponents" />
      <ComponentGroupRef Id="DesktopShortcutComponents" />
    </Feature>

    <!-- Launch app after install -->
    <CustomAction Id="LaunchApplication" 
                  ExeCommand="" 
                  FileRef="MyAppEXE" 
                  Impersonate="yes" 
                  Return="asyncNoWait" />
    
    <InstallExecuteSequence>
      <Custom Action="LaunchApplication" After="InstallFinalize">NOT Installed AND NOT REMOVE</Custom>
    </InstallExecuteSequence>

  </Package>
</Wix>
